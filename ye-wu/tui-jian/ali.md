# ali

智能创意

外投的广告来源和主搜的广告来源不一样，外投的广告是商务团队一对一跟商家谈的，比如在618，双十一节点，问欧莱雅这次想主推的商品是什么，然后获取到对应想投放的商品item。所以商品item量级小，最大也就1w左右。对于这1w个商品，至少每个商品要做一个商品图，这样对设计人员的压力很大，做1w个图要做很久。而且一个图也会比较单调，至少要出几个图。解决这个问题的方式是智能创意：

* 设计只出模板图，模板图中间有抠图的留白位置
* 线上做一个召回系统召回商品item
* 把商品图放到模板图的空白位置，在线合图，变成最后的创意图，形成最终的智能创意。

所以核心变成了做一个召回。外投的召回因为没有明确的上下文（查询词），整体偏靠推荐类的召回：

* cf类召回，item cf，user cf
* lookalike，行为类，也像item cf
* ann召回等

最后构建了这样一个召回系统。这样看起来也就是做了一个推荐召回，亮点主要在系统是使用tf serving来实现的。

* tensorflow的原理，用python构造模型结构，做training，最后得到ckpt和graph文件；线上load这个graph得到图结构，最后变成tf serving
* 如果在python定义时候用的不是数学函数，而是自定义的op，那就可以加载自定义的操作进去
* 这样可以实现一种trick，如果所有的函数都是自定义op，tf serving变成了一种图引擎执行的框架。
* ali有一个aios，aios的召回系统叫be，basic engine，basic engine的底层原理就是tensorflow
* 为什么不直接用basic engine：
  * be是proxy leaf典型两层结构，面向全网大规模商品召回场景。比如人家一万一个leaf，1000个leaf，那对于外投场景就只能用一个leaf，没必要部署两个
  * mama跟主搜的k8s是不互通的，遇到双十一大促等，机器怎么分就会有卡点；运维上实际是隔离的
  * 为什么不搬过来be：两层结构对于我们有一些多余，be的一些特性如filter，scorer等也用不上。所以就研究be的底层原理，最后发现了tf serving这块，最后搬迁这块逻辑
* 主要做的工作就是tf库与mama k8s容器的结合，流程打通，mvc代码目录设计等；还有一些算子内的并行优化，如tf的work shard机制
* 缺点，tf serving做图引擎很重，比如tf serving内部有一些运行在GPU还是CPU上的定义，这些特性用不上



扩展问题：线上为什么不会直接用tf serving，tf serving的性能问题有哪些

